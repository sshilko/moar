---
layout: post
title: Trying out serverless in 2020
---

2018 and 2019 is when [Kubernetes](https://www.cncf.io/blog/2018/03/06/kubernetes-first-cncf-project-graduate/) and [Serverless](https://serverless.com/blog/) became mainstream.
2020 is when we tried Serverless and Microservices in production.


- [Kubernetes](https://kubernetes.io/blog/) graduated from CNCF in 2018 
- [Kubeless](The Kubernetes Native Serverless Framework) FAAS on Kubernetes
- [AWS Lambda now supports Java 11](https://aws.amazon.com/about-aws/whats-new/2019/11/aws-lambda-supports-java-11/)
- AWS API Gateway v2 for HTTP (replacement of ALB+Lambda combo)
- AWS Lambda Destinations and Asynchronous Invocation Improvements
- Announcing Serverless CI/CD (2020)
- AWS Native [SAM](https://aws.amazon.com/serverless/sam/) alternative to serverless.com
- [AWS Lambda Now Supports Custom Runtimes](https://aws.amazon.com/about-aws/whats-new/2018/11/aws-lambda-now-supports-custom-runtimes-and-layers/)
- [PHP goes serverless with Laravel Vapor in 2019](https://vapor.laravel.com/)
- [The AWS Serverless Application Repository](https://aws.amazon.com/serverless/serverlessrepo/)
- [AWS App Mesh Service Discovery](https://aws.amazon.com/about-aws/whats-new/2019/06/aws-app-mesh-service-discovery-with-aws-cloud-map-generally-available/)
- [CNCF Cloud Native Interactive Landscape](https://landscape.cncf.io/format=serverless)
- [AWS Database Migration Service got more mature](https://docs.aws.amazon.com/dms/index.html)
- [Go](https://golang.org/) released modules support finally in 1.13
- AOT JVM based micro-frameworks for Serverless started to gain strength, i.e. [Micronaut](https://micronaut.io) or [Quarkus](https://quarkus.io)
- [Improved VPC networking for AWS Lambda functions](https://aws.amazon.com/blogs/compute/announcing-improved-vpc-networking-for-aws-lambda-functions/)
- [AWS Savings Plan Update: Save Up to 17% On Your Lambda](https://aws.amazon.com/blogs/aws/savings-plan-update-save-up-to-17-on-your-lambda-workloads/)
...


#### Part 1 - Legacy

We have our backend in PHP7.3 and upgrade to new version of PHP every year.
This way we stay compatible with latest releases, but we do not rewrite everything in PHP7.3 every year.

* Backend is >5 years SOA app.
* Runs on AWS in Docker.
* Has internal services, modules, that communicate via RPC
* Codebase and features are stable
* Backend has thousands of users, with hundreds of requests per second

#### Part 3 - Dream

![serverless2019](/images/serverless2019.jpg)

We wanted to try serverless/microservices since summer 2019, as a small dev team it had clear benefits for us (tradeoffs).
November 2019 JIRA ticked named "Implement microservice X" made it into sprint.

High level wish list

- Replace legacy PHP internal service
- Try serverless
- Expose microservice as REST API
- Expose autogenerated documentation
- Try new language/runtime (Java, Kotlin, Go, Python ... [PHP runs in Kubeless](https://github.com/kubeless/kubeless/tree/master/examples/php) btw.)
- Performance monitoring, increased security/access patterbs, create reusable stack for future (micro)services
- Console/cli deployment, turnkey solution with only AWS key & secret
- Try DynamoDB on big scale

#### Part 4 - Beginning

- Use AWS Lambda
- Benchmarks of various cold-start/runtimes showed Golang/JVM good results, we selected JVM (Java8)
- Among JVM we found out [Micronaut framework](https://guides.micronaut.io/micronaut-function-aws-lambda/guide/index.html) to be really similar with SpringBoot, standard AWS SDK for Java (com.amazonaws:aws-java-sdk-s3:1.11.500)
- We used JVM8 because AWSSDK2 was not yet stable/released.
- We used [Serverless.com](https://serverless.com/) framework as recommended by other frond-end team that had experience with it,
- [AWS SAM](https://aws.amazon.com/serverless/sam/) lacked features we needed (ALB setup out of the box).
- PHP service to be replaced with similar REST API
- RDS database replaced with DynamoDB serverless database
- Micronaut supports generating Swagger documentation (OpenAPI)
- Kotlin with Micronaut
- Monitoring by AWS CloudWatch
- Service scales "ondemand" from 0 to "alot"
- [Serverless.com](https://serverless.com/) framework only needs AWS Key&Secret to deploy, app build is inside MultiStage Docker using [Coretto](https://aws.amazon.com/corretto/).
- Code and deployment hosted in separate git repository (polyrepo)

#### Part 5 - Reality (spoilers)

- ðŸ˜’ Kotlin/Micronaut is "large" 23.5MB JAR file and utilize 230Mb memory (AWS CloudWatch)
- ðŸ˜’ Kotlin lacked documentation for serverless
- Should have written Kotlin tests from the beginning
- ðŸ˜¥ [AWS DMS Migration](https://aws.amazon.com/blogs/database/debugging-your-aws-dms-migrations-what-to-do-when-things-go-wrong-part-3/) (RDS->Dynamodb) took us 2 weeks !!! to figure out with try/fail,
there is very very little on debugging DMS migrations, thigs you will not encounter on small/test datasets but that WILL happen on big production migrations
* ðŸ˜• Limited information on how to choose DMS task configuration (defaults not optimized)
* ðŸ˜• DMS is slow (defaults not optimized)
* ðŸ˜• DMS Configuration is really specific to source and destination (Oracle->PostgreSQL, MySQL->DynamoDB etc.) every combination has its own options,
* ðŸ˜• DMS fine tuning is done via editing JSON configuration (no available via UI)

Migration to DynamoDB

- Migration and Migration & Replication are NOT the same, Replication has hidden issues as of 01.2020
- Only 7000...8000 write capacity units using biggest migration instance and concurrent processes ... stable migration at 4000 capacity, otherwise errors
- DMS instance CPU bottleneck
- ðŸ˜¥ ```Last Error Task 'MYJHGWWJB54WQBZ76XXXXXXX' was suspended due to 6 successive unexpected failures Stop Reason FATAL_ERROR Error Level FATAL```
- StackOverflowTuning has little effects 
```
unloadTimeout
ForceUnloadTimeout
``` 
- MySQL access permissions needed
```
   #GRANT REPLICATION CLIENT ...
    REPLICATION CLIENT â€“ This privilege is required for change data capture (CDC) tasks only. 
    REPLICATION SLAVE  â€“ This privilege is required for change data capture (CDC) tasks only. 
    SUPER              â€“ This privilege is required only in MySQL versions before 5.6.6.
```
- AWS Magic required for RDS binlogs for production-size DMS migrations 
```
call mysql.rds_show_configuration;
call mysql.rds_set_configuration('binlog retention hours', 24);
```
- Task settings that worked for us - recommended SQL->DynamoDB task, this is mostly black/poor-documented low-level magic we had to exercise
```
TargetMetadata.ParallelLoadThreads: 24
TargetMetadata.BatchApplyEnabled: false
FullLoadSettings.TransactionConsistencyTimeout: 300
FullLoadSettings.CommitRate: 20000
StreamBufferSettings.StreamBufferCount: 12
StreamBufferSettings.StreamBufferSizeInMB: 40
StreamBufferSettings.CtrlStreamBufferSizeInMB: 8
ChangeProcessingTuning.MinTransactionSize: 1000
ChangeProcessingTuning.CommitTimeout: 5
ChangeProcessingTuning.MemoryLimitTotal: 1024
ChangeProcessingTuning.MemoryKeepTime: 60
ChangeProcessingTuning.StatementCacheSize: 50
```

#### Part 6 - tres meses despues

Overall API response times during migration from PHP+SQL solution to AWS/Serverless + DynamoDB

![2020_Clients_SLA](/images/serverless2020/2020_Clients_SLA.png)

API response 50/95/99% 

![2020_Clients_SLA_P](/images/serverless2020/2020_Clients_SLA_P.png)

Microservice response - timings measured on *client side* (no percentiles unfortunatelly, NewRelic)

![2020_AWSLambda_MicronautResponseTimes](/images/serverless2020/2020_AWSLambda_MicronautResponseTimes.png)

Microservice response - timings measured on *Lambda side* (AWS CloudWatch)

![2020_AWSLambda_MicronautStats](/images/serverless2020/2020_AWSLambda_MicronautStats.png)

#### Summary

![2020_club](/images/serverless2020/2020_club.jpg)

We will continue learning and trying out new technologies thru 2020.
We are happy to see the solution works stable with zero maintenance overhead.

Achievements unlocked:

- removed memory hungry processing out into lambda and freed more memory inside docker for more PHP workers
- reduced the 95% and 99% response times, and removed long S3 calls into AWS Lambda where they dont 
consume limited EC2/Docker resources (memory!)
- deprecated legacy PHP codebase, cleaned up SQL database of unnecessary data (non relational)
- new microservice can be improved/deployed/maintained completely separate of main codebase
- we learned many new things on practice: 
  - new language - Kotlin `kotlinVersion=1.3.50` & Java (1.8)
  - new framework `micronautVersion=1.2.9` - Micronaut, Micronaut Test (io.micronaut.test:micronaut-test-kotlintest), AWS Java SDK
  - new CI/CD framework - AWS SAM, Serverless.com
  - new runtime - AWS Lambda
  - new database - AWS DynamoDB
  - zero downtime migration of production/big databases from SQL to DynamoDB

#### Bonus, a different point of views

- [Microservices guru warns devs that trendy architecture shouldn't be the default for every app, but 'a last resort'](https://www.theregister.co.uk/2020/03/04/microservices_last_resort/)
- [Kubernetes is not a silver bullet](https://www.techradar.com/news/kubernetes-is-not-a-silver-bullet)
- [Monoliths are the future](https://changelog.com/posts/monoliths-are-the-future)
- [Give Me Back My Monolith](http://www.craigkerstiens.com/2019/03/13/give-me-back-my-monolith/)
- [Well Architected Monoliths are Okay](https://robertnorthard.com/devops-days-well-architected-monoliths-are-okay/)
- [Don't ask if a monorepo is good for you â€“ ask if you're good enough for a monorepo](https://yosefk.com/blog/dont-ask-if-a-monorepo-is-good-for-you-ask-if-youre-good-enough-for-a-monorepo.html)
- [The Many Benefits of Using a Monorepo ](https://pspdfkit.com/blog/2019/benefits-of-a-monorepo/)
- [Cold start / Warm start with AWS Lambda](https://blog.octo.com/en/cold-start-warm-start-with-aws-lambda/)

#### Acknowledgments

Carolina A. for pressing the production deployment button during peak load times on wednesday 26th.

#### Update 26 Feb 2020
   * Initial release
   
#### Update 5 Mar 2020
   * Revisit some details and bonus articles
