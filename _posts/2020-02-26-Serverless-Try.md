---
layout: post
title: Trying out serverless in 2020
---

#### Part I - Hype 

2018 and 2019 is when [Kubernetes](https://www.cncf.io/blog/2018/03/06/kubernetes-first-cncf-project-graduate/) and [Serverless](https://serverless.com/blog/) became mainstream.

- [Kubernetes](https://kubernetes.io/blog/) graduated from CNCF in 2018 
- [Kubeless](The Kubernetes Native Serverless Framework) FAAS on Kubernetes
- [AWS Lambda now supports Java 11](https://aws.amazon.com/about-aws/whats-new/2019/11/aws-lambda-supports-java-11/)
- AWS API Gateway v2 for HTTP (replacement of ALB+Lambda combo)
- AWS Lambda Destinations and Asynchronous Invocation Improvements
- Announcing Serverless CI/CD (2020)
- AWS Native [SAM](https://aws.amazon.com/serverless/sam/) alternative to serverless.com
- [AWS Lambda Now Supports Custom Runtimes](https://aws.amazon.com/about-aws/whats-new/2018/11/aws-lambda-now-supports-custom-runtimes-and-layers/)
- [PHP goes serverless with Laravel Vapor in 2019](https://vapor.laravel.com/)
- [The AWS Serverless Application Repository](https://aws.amazon.com/serverless/serverlessrepo/)
- [AWS App Mesh Service Discovery](https://aws.amazon.com/about-aws/whats-new/2019/06/aws-app-mesh-service-discovery-with-aws-cloud-map-generally-available/)
- [CNCF Cloud Native Interactive Landscape](https://landscape.cncf.io/format=serverless)
- [AWS Database Migration Service got more mature](https://docs.aws.amazon.com/dms/index.html)
- [Go](https://golang.org/) released modules support finally in 1.13
- AOT JVM based micro-frameworks for Serverless started to gain strength, i.e. [Micronaut](micronaut.io) or [Quarkus](quarkus.io)
- [Improved VPC networking for AWS Lambda functions](https://aws.amazon.com/blogs/compute/announcing-improved-vpc-networking-for-aws-lambda-functions/)
...

We wanted to try and finally in summer 2019 we decided to try out microservices.

#### Part II - Legacy

We have our backend in PHP7.3 and every year we migrate to new version of PHP, but that only means we clean-up our codebase
to be compatible with latest releases, we dont have time/luxury to rewrite everything every year.

* Backend is >5 years SOA backend app that exposes API.
* Everything runs on AWS inside Docker.
* We follow KISS and SOA, we did few "internal services" that communicate over JSON-RPC API
* Codebase is pretty stable <0.1% errors
* App is in Production for years, cant afford downtime

#### Part III - Dream

![ThEdReAm](/images/serverless2019.jpg)

Somewhere in November 2019 we finally decided on the JIRA ticked and put research ticket into sprint.

TLDR

- Replace one PHP service 
- Scale to 0 (reduce costs)
- Use serverless (no servers please)
- Expose as REST API
- Expose nice autogenerated documentation
- Try out new language (Java, Kotlin, Go, Python ... [PHP runs in Kubeless](https://github.com/kubeless/kubeless/tree/master/examples/php) btw.)
- Better monitoring, more security, develope common standard/stack for future microservices
- Standard (no UI) console-only/cli deployment, turnkey solution

The service involved
- AWS S3
- AWS RDS

and we decided to swap it to
- AWS S3
- AWS DynamoDB

to be completely "Serverless"

#### Part VI - Beginning

- As we already use AWS, we decided to go with AWS Lambda.
- Looking at multiple benchmarks/cold-start of runtimes, we ended up with Golang/JVM options, and decided for JVM
- Among JVM we found out [Micronaut framework](https://guides.micronaut.io/micronaut-function-aws-lambda/guide/index.html) to be really similar with SpringBoot, and otherwise standard AWS SDK for Java
- We used JVM8 because AWSSDK2 was not yet stable/released by the time.
- We used [Serverless.com](https://serverless.com/) framework as recommended by other frond-end team that had experience with it,
also [AWS SAM](https://aws.amazon.com/serverless/sam/) lacked some of the features we needed, like Lambda+ALB setup out of the box.

- PHP service will be replaced with really similar Rest API running AWS Lambda HTTP endpoint
- RDS database will be replaced with DynamoDB serverless database
- Micronaut supports generating Swagger documentation out of the box
- We used Kotlin with Micronaut to spice things up and bring more challenge
- All monitoring is provided by AWS CloudWatch and is out-of-the-box
- Service scales "ondemand" from 0 to "alot", there are /keaplive endpoint connected to ALB healthckeck to prevent cold-start
- Serverless.com framework only needs AWS KEY/Secret to deploy, whole build of Kotlin/Java is done inside MultiStage docker files of 
standard aws/java corretto images and does not require anything except docker installed.
- Whole code and everything needed for deployment is hosted in separate Github repository

#### Part V - Reality (spoilers)

- Kotlin lacked alot of documentation for serverless domain
- Should have written Kotlin tests from the beginning
- [AWS DMS Migration](https://aws.amazon.com/blogs/database/debugging-your-aws-dms-migrations-what-to-do-when-things-go-wrong-part-3/) (RDS->Dynamodb) took us 2 weeks !!! to figure out with try/fail,
there is very very little on debugging DMS migrations, thigs you will not encounter on small/test datasets but that WILL happen on big production migrations
* How to choose DMS Instance size ??? (TLDR just pick the biggest instance c4.4xlarge)
* How to choose DMS task configuration ??? (TLDR defaults wont work)
* Why DMS is so slow ??? (TLDR defaults suck)
* DMS Configuration is really specific to source and destination (Oracle->PostgreSQL, MySQL->DynamoDB, ...) every combination has its own options,
that you can only fine-tune by editing JSON task configuration (no UI, very little help)

If you migrate to DynamoDB, we got some experince =)

- Migration and Migration+Replication are NOT the same experince, latter has much more hidden issues
- Not more than 7000~8000 capacity units writes on DynamoDB... or it will fail, we had to fall back to ~4000 capacity for stable migration
- pick biggest DMS instance for migration, CPU is the bottleneck
- This happens `Last Error Task 'MYJHGWWJB54WQBZ76XXXXXXX' was suspended due to 6 successive unexpected failures Stop Reason FATAL_ERROR Error Level FATAL` and you wont get any other logs
- Try tuning `unloadTimeout`, `ForceUnloadTimeout` but in our case that didnt help, something somewhere times-out
- You can use `root` user for source, but for MySQL you only need read-only access with `GRANT REPLICATION CLIENT` permissions
```
    REPLICATION CLIENT – This privilege is required for change data capture (CDC) tasks only. In other words, full-load-only tasks don't require this privilege.
    REPLICATION SLAVE  – This privilege is required for change data capture (CDC) tasks only. In other words, full-load-only tasks don't require this privilege.
    SUPER              – This privilege is required only in MySQL versions before 5.6.6.
```
- Ever heard of `call mysql.rds_show_configuration` ? or `call mysql.rds_set_configuration('binlog retention hours', 24);` well now you did
- Recommended SQL->DynamoDB settings for Task, this is mostly black magic, but there is very little documentation on it
 
```
TargetMetadata.ParallelLoadThreads: 24
TargetMetadata.BatchApplyEnabled: false
FullLoadSettings.TransactionConsistencyTimeout: 300
FullLoadSettings.CommitRate: 20000
StreamBufferSettings.StreamBufferCount: 12
StreamBufferSettings.StreamBufferSizeInMB: 40
StreamBufferSettings.CtrlStreamBufferSizeInMB: 8
ChangeProcessingTuning.MinTransactionSize: 1000
ChangeProcessingTuning.CommitTimeout: 5
ChangeProcessingTuning.MemoryLimitTotal: 1024
ChangeProcessingTuning.MemoryKeepTime: 60
ChangeProcessingTuning.StatementCacheSize: 50
```


#### Part VI - tres meses despues

TODO add charts/graphs/versions ...

#### Update 26 Feb 2020
   * Initial release